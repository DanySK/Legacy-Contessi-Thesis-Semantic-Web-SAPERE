<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia at May 30, 2012 -->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
        <meta name="Date-Revision-yyyymmdd" content="20120530" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
      </head>
  <body class="composite">
    <div id="banner">
                  <span id="bannerLeft">
                                                <img src="images/logo.png" alt="" />
                </span>
                              <a href="http://maven.apache.org" id="bannerRight">
                                        <img src="http://maven.apache.org/images/maven-logo-2.gif" alt="" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                         <div class="xleft">
        Last Published: 30 May 2012
                      </div>
            <div class="xright">            <a href="http://www.sapere-project.eu" class="externalLink">SAPERE Project</a>
            |
                <a href="http://www.apice.unibo.it/" class="externalLink">APICe Lab</a>
            |
                <a href="http://www.apice.unibo.it/xwiki/bin/view/Theses/semanticwebsapere/" class="externalLink">Thesis space</a>
            |
                <a href="mailto:paolo.contessi@studio.unibo.it/" class="externalLink">Contact</a>
              
               </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                                         <h5>Project Workflow</h5>
                  <ul>
                  <li class="none">
                  <a href="project-summary.html">Introduction</a>
            </li>
                  <li class="none">
                  <a href="workflow/requirements.html">Requirements</a>
            </li>
                                                                                                                                                                                                        <li class="collapsed">
                  <a href="workflow/tech-ref.html">Tech Reference</a>
                  </li>
                                                                                      <li class="collapsed">
                  <a href="workflow/analysis.html">Analysis</a>
                  </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                              <li class="collapsed">
                  <a href="project-info.html">Project Information</a>
                  </li>
                                                                                                                                                                                                            <li class="expanded">
                  <a href="project-reports.html">Project Reports</a>
                    <ul>
                      <li class="none">
                  <a href="pmd.html">PMD Report</a>
            </li>
                      <li class="none">
            <strong>CPD Report</strong>
          </li>
                      <li class="none">
                  <a href="checkstyle-aggregate.html">Checkstyle</a>
            </li>
                      <li class="none">
                  <a href="testapidocs/index.html">Test JavaDocs</a>
            </li>
                      <li class="none">
                  <a href="apidocs/index.html">JavaDocs</a>
            </li>
                      <li class="none">
                  <a href="surefire-report.html">Surefire Report</a>
            </li>
                      <li class="none">
                  <a href="xref/index.html">Source Xref</a>
            </li>
                      <li class="none">
                  <a href="xref-test/index.html">Test Source Xref</a>
            </li>
              </ul>
        </li>
          </ul>
                                 <h5>Modules</h5>
                  <ul>
                  <li class="none">
                  <a href="semanticwebsapere-requirements/index.html">SAPERE Semantic Web Requirements</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-api/index.html">SAPERE API</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-testplan/index.html">SAPERE API Testing Plan</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-rdfmodel/index.html">SAPERE RDF-based model</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-rdfspace/index.html">SAPERE LSA-space (RDF)</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-node/index.html">SAPERE Node</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-integrationtests/index.html">SAPERE Integration Tests</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-experimenters/index.html">SAPERE Experimenters</a>
            </li>
                  <li class="none">
                  <a href="semanticwebsapere-pellet/index.html">Pellet OWL Reasoner</a>
            </li>
          </ul>
                                 <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
          <img alt="Built by Maven" src="./images/logos/maven-feather.png"/>
        </a>
                       
                     </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section"><h2>CPD Results<a name="CPD_Results"></a></h2><p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 4.3.</p></div><div class="section"><h2>Duplications<a name="Duplications"></a></h2><table border="0" class="bodyTable"><tr class="a"><th>File</th><th>Project</th><th>Line</th></tr><tr class="b"><td>it/apice/sapere/api/internal/Jena2SAPEREConverter.java</td><td>SAPERE RDF-based model</td><td><a href="./xref/it/apice/sapere/api/internal/Jena2SAPEREConverter.html#36">36</a></td></tr><tr class="a"><td>it/apice/sapere/space/impl/Jena2SAPEREConverter.java</td><td>SAPERE LSA-space (RDF)</td><td><a href="./xref/it/apice/sapere/space/impl/Jena2SAPEREConverter.html#36">36</a></td></tr><tr class="b"><td colspan='3'><div><pre>public class Jena2SAPEREConverter {

	/** URI of rdf:type property. */
	private static final transient String RDF_TYPE_PROP = &quot;http://&quot;
			+ &quot;www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;;

	/** URI of sapere:LSA class. */
	private static final transient String LSA_CLASS = &quot;http://&quot;
			+ &quot;www.sapere-project.eu/ontologies/2012/0/sapere-model.owl#LSA&quot;;

	/** SAPERE Model Factory. */
	private transient PrivilegedLSAFactory factory;

	/**
	 * &lt;p&gt;
	 * Builds a new Jena2SAPEREConverter.
	 * &lt;/p&gt;
	 * 
	 * @param aFactory
	 *            A PrivislegedLSAFactory
	 */
	public Jena2SAPEREConverter(final PrivilegedLSAFactory aFactory) {
		factory = aFactory;
	}

	/**
	 * &lt;p&gt;
	 * Retrieves a reference to the (Privileged) LSA Factory.
	 * &lt;/p&gt;
	 *
	 * @return Reference to the factory
	 */
	public final PrivilegedLSAFactory getFactory() {
		return factory;
	}

	/**
	 * &lt;p&gt;
	 * Extracts LSAs from a model and parses them.
	 * &lt;/p&gt;
	 * 
	 * @param model
	 *            The model to be processed
	 * @return All found LSAs
	 * @throws Exception
	 *             Cannot process
	 */
	public final Set&lt;LSA&gt; parseJenaModel(final Model model) throws Exception {
		final Set&lt;LSA&gt; res = new HashSet&lt;LSA&gt;();
		final ResIterator iter = model.listSubjectsWithProperty(
				model.createProperty(RDF_TYPE_PROP),
				model.createResource(LSA_CLASS));
		while (iter.hasNext()) {
			res.add(parseLSA(iter.next(), model));
		}

		return res;
	}

	/**
	 * &lt;p&gt;
	 * Parses the provided resource in order to extract the LSA.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The resource to be parsed
	 * @param model
	 *            The model from which LSAs have been extracted
	 * @return The parsed LSA
	 * @throws Exception
	 *             Invalid URI (should not occur)
	 */
	public final LSA parseLSA(final Resource lsa, final Model model)
			throws Exception {
		final LSA res = factory.createLSA(factory.createLSAid(new URI(lsa
				.getURI())));

		populateLSA(res.getSemanticDescription(), lsa, model);

		return res;
	}

	/**
	 * &lt;p&gt;
	 * Inspects the model, to populate the LSA.
	 * &lt;/p&gt;
	 * 
	 * @param sdesc
	 *            The LSA's Semantic Description to be populated
	 * @param res
	 *            The resource representing the LSA in the model
	 * @param model
	 *            The model to inspected
	 * @throws Exception
	 *             Something went wrong during model navigation
	 */
	private void populateLSA(final SemanticDescription sdesc,
			final Resource res, final Model model) throws Exception {
		final ResultSet iter = execQuery(model, lsaPropsQuery(res));
		while (iter.hasNext()) {
			final Resource curr = iter.next().getResource(propVar());
			if (!curr.getURI().equals(RDF_TYPE_PROP)) {
				sdesc.addProperty(parseProperty(model, res, curr.getURI()));
			}
		}
	}

	/**
	 * &lt;p&gt;
	 * Retrieves the name of the query's prop variable.
	 * &lt;/p&gt;
	 * 
	 * @return Name of the prop var
	 */
	private String propVar() {
		return &quot;?prop&quot;;
	}

	/**
	 * &lt;p&gt;
	 * Retrieves the name of the query's obj variable.
	 * &lt;/p&gt;
	 * 
	 * @return Name of the obj var
	 */
	private String objVar() {
		return &quot;?obj&quot;;
	}

	/**
	 * &lt;p&gt;
	 * Retrieves the text of the SPARQL query which will retrieve LSA's
	 * properties.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The LSA to be inspected
	 * @return The query string
	 */
	private String lsaPropsQueryText(final Resource lsa) {
		return &quot;SELECT DISTINCT &quot; + propVar() + &quot; WHERE { &lt;&quot; + lsa.getURI()
				+ &quot;&gt; &quot; + propVar() + &quot; &quot; + objVar() + &quot; }&quot;;
	}

	/**
	 * &lt;p&gt;
	 * Retrieves the text of the SPARQL query which will retrieve values of
	 * LSA's properties.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The LSA to be inspected
	 * @param propURI
	 *            The property whose values should be retrieved
	 * @return The query string
	 */
	private String lsaPropsValuesQueryText(final Resource lsa,
			final String propURI) {
		return &quot;SELECT DISTINCT &quot; + objVar() + &quot; WHERE { &lt;&quot; + lsa.getURI()
				+ &quot;&gt; &lt;&quot; + propURI + &quot;&gt; &quot; + objVar() + &quot; }&quot;;
	}

	/**
	 * &lt;p&gt;
	 * Creates a new query that retrieves LSA's properties.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The LSA whose properties will be retrieved
	 * @return The query object
	 */
	private Query lsaPropsQuery(final Resource lsa) {
		return QueryFactory.create(lsaPropsQueryText(lsa));
	}

	/**
	 * &lt;p&gt;
	 * Creates a new query which will retrieve values of LSA's properties.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The LSA to be inspected
	 * @param propURI
	 *            The property whose values should be retrieved
	 * @return The query object
	 */
	private Query lsaPropsValuesQuery(final Resource lsa, 
			final String propURI) {
		return QueryFactory.create(lsaPropsValuesQueryText(lsa, propURI));
	}

	/**
	 * &lt;p&gt;
	 * Executes a SPARQL query on provided model.
	 * &lt;/p&gt;
	 * 
	 * @param model
	 *            The queried model
	 * @param query
	 *            The query to be executed
	 * @return Query's result set
	 */
	private ResultSet execQuery(final Model model, final Query query) {
		return QueryExecutionFactory.create(query, model).execSelect();
	}

	/**
	 * &lt;p&gt;
	 * Parses an LSA's property.
	 * &lt;/p&gt;
	 * 
	 * @param res
	 *            The resource to be inspected
	 * @param model
	 *            The model on which work
	 * 
	 * @param propURI
	 *            The property in RDF
	 * @return The LSA's property
	 * @throws Exception
	 *             Invalid information provided
	 */
	private it.apice.sapere.api.lsas.Property parseProperty(final Model model,
			final Resource res, final String propURI) throws Exception {
		if (res.isAnon()) {
			return factory.createProperty(new URI(propURI),
					extractAnonValues(model, res, propURI));
		}

		return factory.createProperty(new URI(propURI),
				extractResValues(model, res, propURI));
	}

	/**
	 * &lt;p&gt;
	 * Parses all LSA's property values of a Blank Node.
	 * &lt;/p&gt;
	 * 
	 * @param bnode
	 *            The Blank Node
	 * @param model
	 *            The model on which work
	 * @param propURI
	 *            The property in RDF
	 * @return The list of property values
	 * @throws Exception
	 *             Cannot parse values
	 */
	private PropertyValue&lt;?, ?&gt;[] extractAnonValues(final Model model,
			final Resource bnode, final String propURI) throws Exception {
		final Set&lt;PropertyValue&lt;?, ?&gt;&gt; res = new HashSet&lt;PropertyValue&lt;?, ?&gt;&gt;();
		final StmtIterator iter = bnode.listProperties(model
				.createProperty(propURI));
		while (iter.hasNext()) {
			parseValue(model, res, iter.next().getObject());
		}

		return res.toArray(new PropertyValue&lt;?, ?&gt;[res.size()]);
	}

	/**
	 * &lt;p&gt;
	 * Parses all LSA's property values of a named Resource.
	 * &lt;/p&gt;
	 * 
	 * @param lsa
	 *            The LSA on which work
	 * @param model
	 *            The model on which work
	 * @param propURI
	 *            The property in RDF
	 * @return The list of property values
	 * @throws Exception
	 *             Cannot parse values
	 */
	private PropertyValue&lt;?, ?&gt;[] extractResValues(final Model model,
			final Resource lsa, final String propURI) throws Exception {
		final Set&lt;PropertyValue&lt;?, ?&gt;&gt; res = new HashSet&lt;PropertyValue&lt;?, ?&gt;&gt;();
		final ResultSet iter = execQuery(model,
				lsaPropsValuesQuery(lsa, propURI));
		while (iter.hasNext()) {
			final QuerySolution curr = (QuerySolution) iter.next();
			final RDFNode rVal = curr.get(objVar());

			parseValue(model, res, rVal);
		}

		return res.toArray(new PropertyValue&lt;?, ?&gt;[res.size()]);
	}

	/**
	 * &lt;p&gt;
	 * Parses a value.
	 * &lt;/p&gt;
	 * 
	 * @param model
	 *            The RDF Graph
	 * @param res
	 *            The set of already parsed values
	 * @param rVal
	 *            The property value node
	 * @throws Exception
	 *             Something went wrong
	 */
	private void parseValue(final Model model,
			final Set&lt;PropertyValue&lt;?, ?&gt;&gt; res, final RDFNode rVal)
			throws Exception {
		// Check if there's a Blank Node (nesting)
		if (rVal.isResource() &amp;&amp; rVal.isAnon()) {
			final SDescValue sdv = factory.createNestingPropertyValue();
			final StmtIterator bnodeIter = rVal.asResource().listProperties();
			while (bnodeIter.hasNext()) {
				final Statement stmt = bnodeIter.next();
				final Resource prop = stmt.getPredicate();
				if (!prop.getURI().equals(RDF_TYPE_PROP)) {
					sdv.getValue().addProperty(
							parseProperty(model, rVal.asResource(),
									prop.getURI()));
				}
			}

			res.add(sdv);
		} else if (rVal.isURIResource()) { // Checks if the object is a URI
			res.add(factory.createPropertyValue(new URI(((Resource) rVal
					.as(Resource.class)).getURI())));
		} else if (rVal.isLiteral()) { // Checks if the object is a Literal
			res.add(parseLiteral((Literal) rVal.as(Literal.class)));
		}
	}

	/**
	 * &lt;p&gt;
	 * Parses a value, determining its type.
	 * &lt;/p&gt;
	 * 
	 * @param literal
	 *            The literal to be parsed
	 * @return The property value
	 * @throws Exception
	 *             Cannot parse value
	 */
	private PropertyValue&lt;?, ?&gt; parseLiteral(final Literal literal)
			throws Exception {
		final String langCode = literal.getLanguage();
		final String dataType = literal.getDatatypeURI();
		final Object value = literal.getValue();

		// Typed literal
		if (dataType != null) {
			if (value instanceof Boolean) {
				return factory.createPropertyValue((Boolean) value);
			} else if (value instanceof Double) {
				return factory.createPropertyValue((Double) value);
			} else if (value instanceof Float) {
				return factory.createPropertyValue((Float) value);
			} else if (value instanceof Long) {
				return factory.createPropertyValue((Long) value);
			} else if (value instanceof Integer) {
				return factory.createPropertyValue((Integer) value);
			} else if (value instanceof XSDDateTime) {
				return factory.createPropertyValue(((XSDDateTime) value)
						.asCalendar().getTime());
			} else if (value instanceof Date) {
				return factory.createPropertyValue((Date) value);
			}
		}

		// Plain literal: using String representation..
		if (langCode != null &amp;&amp; !langCode.equals(&quot;&quot;)) {
			return factory.createPropertyValue(literal.getString(), langCode);
		}

		return factory.createPropertyValue(literal.getString());
	}
}</pre></div></td></tr></table></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        &#169;            2012
              APICe Lab, Alma Mater Studiorum - Università degli Studi di Bologna
            
                - <a href="http://maven.apache.org/privacy-policy.html">Privacy Policy</a>.
        Apache Maven, Maven, Apache, the Apache feather logo, and the Apache Maven project logos are trademarks of The Apache Software Foundation.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
